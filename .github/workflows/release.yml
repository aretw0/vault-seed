# .github/workflows/release.yml
name: Publicar Release

# Este workflow √© executado automaticamente quando uma nova tag (ex: v1.0.0) √© criada e enviada para o reposit√≥rio.
# Ele automatiza a cria√ß√£o de releases no GitHub, extraindo as notas do CHANGELOG.md.
# Voc√™ tamb√©m pode execut√°-lo manualmente atrav√©s da aba 'Actions' no GitHub.

on:
  push:
    tags:
      - 'v*' # Executa quando uma nova tag (ex: v1.0.0) √© criada e enviada.
  workflow_dispatch: # Permite execu√ß√£o manual atrav√©s da interface do GitHub Actions

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è Checkout do C√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necess√°rio para que standard-version possa analisar o hist√≥rico completo

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use a vers√£o do Node.js que seu projeto utiliza

      - name: üì¶ Instalar Depend√™ncias
        run: npm install # Instala as depend√™ncias do package.json, incluindo standard-version

      - name: üìù Obter Notas de Release
        id: get_release_notes
        run: |
          # Extrai as notas de release do CHANGELOG.md para a tag atual
          # Isso assume que o CHANGELOG.md √© gerado por standard-version
          RELEASE_VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
          RELEASE_NOTES=$(npx conventional-changelog --tag-prefix v --release-count 1 --output-unreleased=false --lerna-package=false --commit-path=. | sed -n "/^### ${RELEASE_VERSION}/,/^### /p" | sed '$d' | sed '1d')
          
          # Se as notas estiverem vazias, tenta extrair de outra forma (para o primeiro release, por exemplo)
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES=$(npx conventional-changelog --tag-prefix v --release-count 1 --output-unreleased=false --lerna-package=false --commit-path=. | sed -n "/^### ${RELEASE_VERSION}/,/^## /p" | sed '$d' | sed '1d')
          fi

          # Garante que as notas n√£o estejam vazias
          if [ -z "$RELEASE_NOTES" ]; then
            echo "::error::N√£o foi poss√≠vel extrair as notas de release para a vers√£o ${RELEASE_VERSION}."
            exit 1
          fi

          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üöÄ Criar GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ github.ref }}
          body: ${{ steps.get_release_notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GITHUB_TOKEN √© fornecido automaticamente pelo GitHub