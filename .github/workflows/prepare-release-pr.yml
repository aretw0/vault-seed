name: "Prepare Release PR"

on:
  workflow_dispatch:

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: "Checkout main"
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0 # Needed for standard-version and git history

      - name: "Rebase"
        run: git rebase origin/develop

      - name: "Configure Git User"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Cache & Install Dependencies"
        run: |
          npm ci

      - name: "Run standard-version"
        id: standard_version
        # We skip tagging because the release workflow will handle it after merge
        run: |
          npx standard-version --skip.tag
          echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT
          BRANCH_NAME="chore/prepare-release-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore(release): v${{ steps.standard_version.outputs.version }}"
          body: |
            This PR was automatically generated by the `prepare-release-pr` workflow.

            It contains the latest changes from the `develop` branch and a new version bump to **v${{ steps.standard_version.outputs.version }}**.

            **Please review the changes and the generated CHANGELOG before merging.**

            Once this PR is merged, the `release.yml` workflow will be triggered to automatically:
            1. Create the `v${{ steps.standard_version.outputs.version }}` Git tag.
            2. Publish the final GitHub Release.
          delete-branch: true
          labels: "release, automação"
          branch: ${{ steps.standard_version.outputs.branch_name }}
